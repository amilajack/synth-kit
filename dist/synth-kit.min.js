(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(exports):typeof define==="function"&&define.amd?define(["exports"],factory):factory(global.SynthKit=global.SynthKit||{})})(this,function(exports){"use strict";var commonjsGlobal=typeof window!=="undefined"?window:typeof global!=="undefined"?global:typeof self!=="undefined"?self:{};function createCommonjsModule(fn,module){return module={exports:{}},fn(module,module.exports),module.exports}var window_1=createCommonjsModule(function(module){if(typeof window!=="undefined"){module.exports=window}else if(typeof commonjsGlobal!=="undefined"){module.exports=commonjsGlobal}else{module.exports={}}});var index=createCommonjsModule(function(module){var window=window_1;var Context=window.AudioContext||window.webkitAudioContext;if(Context)module.exports=new Context});var proto=Object.getPrototypeOf(Object.getPrototypeOf(index.createGain()));var _connect=proto.connect;proto.connect=function(){_connect.apply(this,arguments);console.log("connect!",this,arguments[0]);return this};function context(ctx){return ctx||index}function dest(context){return(context||index).destination}function now(context){return(context||index).currentTime}function when(time,delay,ctx){return Math.max(now(ctx),time||0)+(delay||0)}var after=when.bind(0);function samplingRate(ctx){return context(ctx).sampleRate}function timeToSamples(secs,context){return secs*samplingRate(context)}function fillStr(s,num){return Array(num+1).join(s)}function isNum(x){return typeof x==="number"}function isStr(x){return typeof x==="string"}function isDef(x){return typeof x!=="undefined"}function midiToFreq(midi,tuning){return Math.pow(2,(midi-69)/12)*(tuning||440)}var REGEX=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function regex(){return REGEX}var SEMITONES=[0,2,4,5,7,9,11];function parse(str,isTonic,tuning){if(typeof str!=="string")return null;var m=REGEX.exec(str);if(!m||!isTonic&&m[4])return null;var p={letter:m[1].toUpperCase(),acc:m[2].replace(/x/g,"##")};p.pc=p.letter+p.acc;p.step=(p.letter.charCodeAt(0)+3)%7;p.alt=p.acc[0]==="b"?-p.acc.length:p.acc.length;var pos=SEMITONES[p.step]+p.alt;p.chroma=pos<0?12+pos:pos%12;if(m[3]){p.oct=+m[3];p.midi=pos+12*(p.oct+1);p.freq=midiToFreq(p.midi,tuning)}if(isTonic)p.tonicOf=m[4];return p}var LETTERS="CDEFGAB";function acc(n){return!isNum(n)?"":n<0?fillStr("b",-n):fillStr("#",n)}function oct(n){return!isNum(n)?"":""+n}function build(s,a,o){if(s===null||typeof s==="undefined")return null;if(s.step)return build(s.step,s.alt,s.oct);if(s<0||s>6)return null;return LETTERS.charAt(s)+acc(a)+oct(o)}function midi(note){if((isNum(note)||isStr(note))&&note>=0&&note<128)return+note;var p=parse(note);return p&&isDef(p.midi)?p.midi:null}function freq(note,tuning){var m=midi(note);return m===null?null:midiToFreq(m,tuning)}var parser={parse:parse,build:build,regex:regex,midi:midi,freq:freq};var FNS=["letter","acc","pc","step","alt","chroma","oct"];FNS.forEach(function(name){parser[name]=function(src){var p=parse(src);return p&&isDef(p[name])?p[name]:null}});var index$1=parser;var pow=Math.pow;function tempo(bpm,sub){return bpm/60*(sub||1)}function note(name,base){return index$1.freq(name)}function hz(value,base){if(typeof value==="string"){base=base||440;return pow(2,(+value-69)/12)*base}else{return Math.abs(+value)}}function dBToGain(db){return pow(2,db/6)}function gainToDb(gain){return 20*(Math.log(gain)/Math.LN10)}var OPTS={};function isA(t,x){return typeof x===t}function toArr(arr){return Array.isArray(arr)?arr:[arr]}var slice=Array.prototype.slice;var isArray=Array.isArray;var assign=Object.assign;function conn(nodes){nodes=isArray(nodes)?nodes:slice.call(arguments);if(!nodes.length)return null;else if(nodes.length===1)return nodes[0];var node=nodes[0];if(!node.duration)node.duration=0;var last=nodes.reduce(function(src,dest$$1){src.connect(dest$$1);node.duration=Math.max(node.duration,dest$$1.duration||0);return dest$$1});overrideConnect(node,last);var startables=nodes.slice(1).filter(isStartable);if(startables.length){var _start=node.start;node.start=function(time){if(_start)_start.call(node,time);startables.forEach(function(node){node.start(time)});if(node.duration)node.stop(time+node.duration)};var _stop=node.stop;node.stop=function(time){var t=0;startables.reverse();startables.forEach(function(node){t=t||when(time,null,node.context);node.stop(t);t+=node.release||0});if(_stop)_stop.call(node,t)}}return node}function add(nodes){nodes=isArray(nodes)?nodes:slice.call(arguments);if(!nodes.length)return null;else if(nodes.length===1)return nodes[0];var context$$1=nodes[0].context;var input=context$$1.createGain();input.id="ADDin";var output=context$$1.createGain();output.id="ADDout";nodes.forEach(function(node){if(node.numberOfInputs)input.connect(node);node.connect(output)});overrideConnect(input,output);var node=lifecycle(input,nodes);addOnEndedEvent(node);return node}function addOnEndedEvent(node){if(!node.dependents)return;var length=node.dependents.length;function triggerEnded(){length--;if(!length&&node.onended)node.onended()}node.dependents.forEach(function(node){node.onended=triggerEnded})}function overrideConnect(node,output){node.output=node;node.connect=function(dest$$1){output.connect(dest$$1);return node};return node}function isStartable(node){return node&&typeof node.start==="function"}function plug(name,value,node){if(typeof value==="undefined"){}else if(typeof value.connect==="function"){node[name].value=0;value.conn(node[name]);return value}else if(node[name]){node[name].value=value}}function lifecycle(node,dependents){dependents=dependents.filter(isStartable);if(dependents.length){var _start=node.start;var _stop=node.stop;node.start=function(time){var res=_start?_start.call(node,time):void 0;dependents.forEach(function(d){if(d.start)d.start(time)});if(node.start.then)node.start.then(time,node,dependents);return res};node.stop=function(time){var res=_stop?_stop.call(node,time):void 0;dependents.forEach(function(d){if(d.stop)d.stop(time)});return res};node.dependents=dependents}return node}function gain(gain,opts){if(arguments.length===1&&!isA("number",gain))return gain(gain.gain,gain);var node=context(opts?opts.context:null).createGain();return lifecycle(node,[plug("gain",gain,node)])}function constant(value,o){var ctx=context(o?o.context:null);var source=ctx.createBufferSource();source.loop=true;source.buffer=ctx.createBuffer(1,2,ctx.sampleRate);var data=source.buffer.getChannelData(0);data[0]=data[1]=value;return source}function signal(value,opts){var signal=gain(value,opts);conn(constant(1,opts),signal).start();signal.signal=signal.gain;return signal}function bypass(o){return context(o?o.context:null).createGain()}function mult(value,signal,opts){if(isA("number",signal))return value*signal;return conn(signal,gain(value,opts))}function scale(min,max,source){var ctx=source;if(source.numberOfInputs)source=conn(constant(1,ctx),source);var delta=max-min;return add(constant(min,ctx),mult(delta,source))}function osc(type,frequency,o){if(!o)o=OPTS;var osc=context(o.context).createOscillator();osc.type=type||"sine";return lifecycle(osc,[plug("frequency",frequency,osc),plug("detune",o.detune,osc)])}const sine=osc.bind(null,"sine");const saw=osc.bind(null,"sawtooth");const square=osc.bind(null,"square");const triangle=osc.bind(null,"triangle");function lfo(freq,amp,o){freq=freq||7;amp=amp||1;o=o||OPTS;if(o.tempo)freq=tempo(o.tempo,freq);return mult(amp,osc(o.type||"sine",freq))}function filter(type,frequency,o){if(isA("object",type)){o=type;type=o.type;frequency=o.frequency}o=o||OPTS;var filter=context(o.context).createBiquadFilter();filter.type=type||"lowpass";return lifecycle(filter,[plug("frequency",frequency,filter),plug("Q",o.Q,filter),plug("detune",o.detune,filter)])}const lowpass=filter.bind(null,"lowpass");const hipass=filter.bind(null,"highpass");const bandpass=filter.bind(null,"hipass");var NONE={};function load(url,opts){opts=opts||NONE;return fetch(url,"arraybuffer").then(decodeAudio(context(opts.context)))}function fetch(url,type){type=type==="arraybuffer"?type:"text";return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.responseType=type;xhr.onload=function(){if(xhr.response){resolve(xhr.response)}};xhr.onerror=reject;xhr.send()})}function decodeAudio(ac,arrayBuffer){if(arguments.length===1)return function(array){return decodeAudio(ac,array)};return new Promise(function(resolve,reject){ac.decodeAudioData(arrayBuffer,resolve,reject)})}function source(buffer,o){o=o||OPTS;var src=context(o.context).createBufferSource();src.buffer=isA("function",buffer)?buffer():buffer;if(!src.buffer)console.warn("Buffer not ready.");if(o.loop)src.loop=true;return lifecycle(src,[plug("detune",o.detune,src)])}function sample(url,opts){var bf=null;function buffer(){return bf}var promise=load(url,opts).then(function(buffer){buffer.url=url;bf=buffer;return bf});buffer.then=promise.then.bind(promise);return buffer}function gen(generators,samples,o){samples=samples||2;o=o||OPTS;return function(){if(!Array.isArray(generators))generators=[generators];var reverse=o.reverse;var numOfChannels=generators.length;var ctx=context(o.context);var buffer=ctx.createBuffer(numOfChannels,samples,samplingRate(ctx));for(var ch=0;ch<numOfChannels;ch++){generateData(generators[ch],buffer.getChannelData(ch),samples,reverse)}return buffer}}function generateData(generator,data,samples,reverse){for(var i=0;i<samples;i++){data[i]=generator(reverse?samples-i:i)}}function white(samples,options){if(!isA("number",samples))samples=samplingRate(options);return source(gen(white.generator,samples,options),options)}white.generator=function(){return Math.random()*2-1};function eachStage(stages,fn){stages.forEach(function(s){fn.apply(null,s)})}function perc(attack,decay,opts){if(isA("object",attack))return perc(attack.attack,attack.decay,attack);var a=[[0,0,"set"],[attack||.01,1,"lin"],[decay||.2,0,"exp"]];return envelope(a,null,opts)}var ADSR=[.01,.1,.8,.3];function adsr(o){o=o||OPTS;var adsr=o.adsr||ADSR;if(!isA("number",o.attack))o.attack=adsr[0];if(!isA("number",o.decay))o.decay=adsr[1];if(!isA("number",o.sustain))o.sustain=adsr[2];if(!isA("number",o.release))o.release=adsr[3];var a=[[0,0,"set"],[o.attack,1,"lin"],[o.decay,o.sustain,"exp"]];var r=[[0,o.sustain,"set"],[o.release,0,"exp"]];return envelope(a,r,o)}function envelope(attEnvelope,relEnvelope,opts){var g=gain(0,opts);g.start=apply(g.gain,attEnvelope);if(!relEnvelope){g.duration=duration(attEnvelope);g.stop=function(){}}else{g.stop=apply(g.gain,relEnvelope);g.release=duration(relEnvelope)}return g}function apply(param,contour){return function(t){t=when(t,0,param.context);eachStage(contour,function(time,value,type){t+=time;if(type==="set")param.setValueAtTime(value,t);else if(type==="lin")param.linearRampToValueAtTime(value,t);else if(type==="exp")param.exponentialRampToValueAtTime(value!==0?value:1e-5,t);else console.warn("Invalid stage type",time,value,type)})}}function duration(contour){return contour.reduce(function(dur,stage){return dur+stage[0]},0)}function mix(wet,fx,opts){if(arguments.length===1)return function(w,o){return mix(w,wet,o)};if(!isA("number",wet))wet=.5;opts=opts||OPTS;var dry=opts.compensate===false?1:1-wet;console.log("MIX",wet,dry,opts);return add(gain(dry),conn(fx,gain(wet)))}function feedback(amount,node,options){var feed=gain(amount,options);node.conn(feed);feed.conn(node);return node}function tremolo(rate,type,ac){type=type||"sine";return gain(osc(type,rate,ac),ac)}function dly(time,opts){opts=opts||OPTS;var dly=context(opts.context).createDelay(5);return lifecycle(dly,[plug("delayTime",time,dly)])}function convolve(buffer,o){o=o||OPTS;var c=context(o.context).createConvolver();c.buffer=isA("function",buffer)?buffer():buffer;if(o.normalize===true)c.normalize=true;return c}function decayIR(samples,opts){samples=samples||1e4;opts=opts||OPTS;var attack=opts.attack||Math.floor(samples/10);var decay=opts.decay||samples-attack;var base=Math.pow(1/1e3,1/decay);return gen(function(i){var dec=base?Math.pow(base,i):1;var att=i<attack?i/attack:1;return att*white.generator(i)*dec},samples,opts)}function reverb(duration,opts){opts=opts||OPTS;var rate=samplingRate(opts.context);return convolve(decayIR(duration*rate,opts),opts)}function delay(time,filter$$1,feedAmount,ac){if(!isA("number",feedAmount))feedAmount=.3;filter$$1=isA("number",filter$$1)?lowpass(filter$$1,null,null,ac):filter$$1||bypass(ac);return feedback(feedAmount,dly(time,ac),filter$$1,ac)}function withDefaults(synth,defaults){return function(options){return synth(assign({},defaults,options))}}const vca=withDefaults(function(opts){if(!isA("number",opts.gain))opts.gain=dBToGain(opts.dB)||1;return conn(gain(opts),adsr(opts))},{dB:0,attack:.01,decay:.1,sustain:0,release:.1});const vcf=withDefaults(function(opts){var mod=conn(signal(mult(opts.octaves,opts.frequency)),adsr(opts));return filter(opts.type,add(signal(opts.frequency),mod),opts)},{type:"lowpass",frequency:22e3,octaves:2,attack:.01,decay:.1,sustain:0,release:.1});function subtractive(opts){opts=opts||OPTS;return conn(bank(opts),vcf(opts.filter),vca(opts))}function bank(opts){opts=opts||OPTS;var base=opts.ratios?opts.frequency||440:1;var freqs=toArr(opts.frequencies||opts.ratios||440);var gains=toArr(opts.gains||1);var types=toArr(opts.types||"sine");var N=opts.compensate===false?1:freqs.length;var tl=types.length;var gl=gains.length;return conn(add(freqs.map(function(freq,i){var src=osc(types[i%tl],base*freq);var g=gains[i%gl];return g===1?src:conn(src,gain(g))})),gain(1/N))}function withDest(synth,dest){return function(value){var node=synth?synth(value):value;if(dest)node.connect(dest);return node}}var master=inst(null,dest());function inst(synth,destination,options){synth=withDest(synth,destination||dest());return tracker(synth,options||OPTS)}function tracker(synth,opts){var ob=observable({});var limit=opts?opts.maxVoices:0;var voices={limit:limit,all:{},nextId:0,current:0,pool:new Array(limit)};function track(node){node.id=voices.nextId++;voices.all[node.id]=node;on(node,"ended",function(){delete voices.all[node.id];ob.event("voices",Object.keys(voices.all),limit)});return node}ob.start=function(value,time,delay,duration){var node=synth(value);if(node.start){track(node);time=start(node,time,delay,duration).startedAt;ob.event("start",node.id,time);ob.event("voices",Object.keys(voices.all),limit)}return node};ob.stop=function(ids,time,delay){var t=0;ids=toArr(ids||ids===0?ids:Object.keys(voices.all));ids.forEach(function(id){if(voices.all[id]){if(!t)t=when(time,delay,voices.all[id].context);voices.all[id].stop(t)}})};return ob}function start(node,time,delay,duration){if(time&&!isA("number",time))throw Error("Invalid time (maybe forgot connect?): ",time,delay,duration,node);time=when(time,delay,context(node.context));node.start(time);node.startedAt=time;var d=duration||node.duration;if(d)node.stop(time+d);return node}function observable(obj){obj.on=on.bind(null,obj);obj.event=event.bind(null,obj);return obj}function on(target,name,callback){if(!name||name==="*")name="event";var prev=target["on"+name];target["on"+name]=function(){if(prev)prev.apply(null,arguments);callback.apply(null,arguments)};return target}function event(target,name){var args=slice.call(arguments,1);if(isA("function",target["on"+name]))target["on"+name].apply(null,args);if(isA("function",target.onevent))target.onevent.apply(null,args);return target}exports.context=context;exports.now=now;exports.dest=dest;exports.samplingRate=samplingRate;exports.timeToSamples=timeToSamples;exports.tempo=tempo;exports.note=note;exports.hz=hz;exports.dBToGain=dBToGain;exports.gainToDb=gainToDb;exports.conn=conn;exports.add=add;exports.constant=constant;exports.bypass=bypass;exports.gain=gain;exports.signal=signal;exports.mult=mult;exports.scale=scale;exports.osc=osc;exports.sine=sine;exports.saw=saw;exports.square=square;exports.triangle=triangle;exports.lfo=lfo;exports.filter=filter;exports.lowpass=lowpass;exports.hipass=hipass;exports.bandpass=bandpass;exports.sample=sample;exports.gen=gen;exports.source=source;exports.white=white;exports.load=load;exports.decodeAudio=decodeAudio;exports.fetch=fetch;exports.perc=perc;exports.adsr=adsr;exports.mix=mix;exports.feedback=feedback;exports.tremolo=tremolo;exports.dly=dly;exports.delay=delay;exports.convolve=convolve;exports.decayIR=decayIR;exports.reverb=reverb;exports.withDefaults=withDefaults;exports.vca=vca;exports.vcf=vcf;exports.subtractive=subtractive;exports.bank=bank;exports.inst=inst;exports.master=master;Object.defineProperty(exports,"__esModule",{value:true})});