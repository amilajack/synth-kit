(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(exports):typeof define==="function"&&define.amd?define(["exports"],factory):factory(global.SynthKit=global.SynthKit||{})})(this,function(exports){"use strict";var commonjsGlobal=typeof window!=="undefined"?window:typeof global!=="undefined"?global:typeof self!=="undefined"?self:{};function createCommonjsModule(fn,module){return module={exports:{}},fn(module,module.exports),module.exports}var window_1=createCommonjsModule(function(module){if(typeof window!=="undefined"){module.exports=window}else if(typeof commonjsGlobal!=="undefined"){module.exports=commonjsGlobal}else{module.exports={}}});var index=createCommonjsModule(function(module){var window=window_1;var Context=window.AudioContext||window.webkitAudioContext;if(Context)module.exports=new Context});var proto=Object.getPrototypeOf(Object.getPrototypeOf(index.createGain()));var _connect=proto.connect;proto.connect=function(){_connect.apply(this,arguments);return this};function context(ctx){return ctx||index}function contextOf(node){return node?context(node.context):index}function dest(context){return(context||index).destination}function now(context){return(context||index).currentTime}function when(time,delay,ctx){return Math.max(now(ctx),time||0)+(delay||0)}var after=when.bind(0);function samplingRate(context){return(context||index).sampleRate}function seconds(secs,context){return secs*samplingRate(context)}function fillStr(s,num){return Array(num+1).join(s)}function isNum(x){return typeof x==="number"}function isStr(x){return typeof x==="string"}function isDef(x){return typeof x!=="undefined"}function midiToFreq(midi,tuning){return Math.pow(2,(midi-69)/12)*(tuning||440)}var REGEX=/^([a-gA-G])(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)\s*$/;function regex(){return REGEX}var SEMITONES=[0,2,4,5,7,9,11];function parse(str,isTonic,tuning){if(typeof str!=="string")return null;var m=REGEX.exec(str);if(!m||!isTonic&&m[4])return null;var p={letter:m[1].toUpperCase(),acc:m[2].replace(/x/g,"##")};p.pc=p.letter+p.acc;p.step=(p.letter.charCodeAt(0)+3)%7;p.alt=p.acc[0]==="b"?-p.acc.length:p.acc.length;var pos=SEMITONES[p.step]+p.alt;p.chroma=pos<0?12+pos:pos%12;if(m[3]){p.oct=+m[3];p.midi=pos+12*(p.oct+1);p.freq=midiToFreq(p.midi,tuning)}if(isTonic)p.tonicOf=m[4];return p}var LETTERS="CDEFGAB";function acc(n){return!isNum(n)?"":n<0?fillStr("b",-n):fillStr("#",n)}function oct(n){return!isNum(n)?"":""+n}function build(s,a,o){if(s===null||typeof s==="undefined")return null;if(s.step)return build(s.step,s.alt,s.oct);if(s<0||s>6)return null;return LETTERS.charAt(s)+acc(a)+oct(o)}function midi(note){if((isNum(note)||isStr(note))&&note>=0&&note<128)return+note;var p=parse(note);return p&&isDef(p.midi)?p.midi:null}function freq(note,tuning){var m=midi(note);return m===null?null:midiToFreq(m,tuning)}var parser={parse:parse,build:build,regex:regex,midi:midi,freq:freq};var FNS=["letter","acc","pc","step","alt","chroma","oct"];FNS.forEach(function(name){parser[name]=function(src){var p=parse(src);return p&&isDef(p[name])?p[name]:null}});var index$1=parser;function isNum$1(n){return typeof n==="number"}function isFn(x){return typeof x==="function"}function isStr$1(x){return typeof x==="string"}function isObj(x){return typeof x==="object"}function plug(name,value,node){if(typeof value==="undefined"){}else if(typeof value.connect==="function"){node[name].value=0;value.connect(node[name]);return value}else if(node[name]){node[name].value=value}}function toTime(context,when,delay){return Math.max(context.currentTime,when||0)+(delay||0)}function bindLifecycle(node){return{connect:node.connect?node.connect.bind(node):null,disconnect:node.disconnect?node.disconnect.bind(node):null,start:node.start?node.start.bind(node):null,stop:node.stop?node.stop.bind(node):null}}function dispatch(event,value,node,dependents){if(node[event])node[event](value);dependents.forEach(function(dep){if(dep&&dep[event])dep[event](value)});return node}function lifecycle(node,dependents){var raw=bindLifecycle(node);node.connected=false;node.disconnect=function(){node.connected=false;dispatch("disconnect",null,raw,dependents)};node.start=function(when,delay,duration){var time=toTime(node.context,when,delay);dispatch("start",time,raw,dependents);if(duration)node.stop(time+duration);return node};node.stop=function(when,delay){var time=toTime(node.context,when,delay);dispatch("stop",time,raw,dependents)};return node}function tempo(bpm,sub){return bpm/60*(sub||1)}function note(name,base){return index$1.freq(name)}function hz(value,base){if(isStr$1(value)){base=base||440;return Math.pow(2,(+value-69)/12)*base}else{return Math.abs(+value)}}function dB(db){return Math.pow(2,db/6)}function gainToDb(gain){return 20*(Math.log(gain)/Math.LN10)}function load(url,ac){return fetch(url,"arraybuffer").then(decodeAudio(ac))}function fetch(url,type){type=type==="arraybuffer"?type:"text";return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.responseType=type;xhr.onload=function(){if(xhr.response){resolve(xhr.response)}};xhr.onerror=reject;xhr.send()})}function decodeAudio(ac,arrayBuffer){if(arguments.length===1)return function(array){return decodeAudio(ac,array)};return new Promise(function(resolve,reject){ac.decodeAudioData(arrayBuffer,resolve,reject)})}var slice=Array.prototype.slice;var isArray=Array.isArray;function connect(nodes){nodes=isArray(nodes)?nodes:slice.call(arguments);if(!nodes.length)return null;else if(nodes.length===1)return nodes[0];var first=nodes[0];var last=nodes.reduce(function(src,dest$$1){src.connect(dest$$1);return dest$$1});first.connect=last.connect.bind(last);return lifecycle(first,nodes.slice(1))}function add(nodes){nodes=isArray(nodes)?nodes:slice.call(arguments);if(!nodes.length)return null;else if(nodes.length===1)return nodes[0];var context$$1=nodes[0].context;var input=context$$1.createGain();var output=context$$1.createGain();nodes.forEach(function(node){if(node.numberOfInputs)input.connect(node);node.connect(output)});input.connect=output.connect.bind(output);return lifecycle(input,nodes)}function constant(value,ac){var ctx=context(ac);var source=ctx.createBufferSource();source.loop=true;source.buffer=ctx.createBuffer(1,2,ctx.sampleRate);var data=source.buffer.getChannelData(0);data[0]=data[1]=value;return source}function signal(value,ac){var mod=context(ac).createGain();mod.gain.value=value;var signal=connect(constant(1),mod);signal.value=mod.gain;signal.start();return signal}function bypass(ac){return context(ac).createGain()}function gain(gain,ac){var amp=context(ac).createGain();return lifecycle(amp,[plug("gain",gain,amp)])}function mult(value,signal){return connect(signal,gain(value))}function scale(min,max,source,ctx){if(source.numberOfInputs)source=connect(constant(1,ctx),source);var delta=max-min;return add(constant(min,ctx),mult(delta,source))}function osc(type,frequency,detune,ac){var osc=context(ac).createOscillator();osc.type=type||"sine";return lifecycle(osc,[plug("frequency",frequency,osc),plug("detune",detune,osc)])}const sine=osc.bind(null,"sine");const saw=osc.bind(null,"sawtooth");const square=osc.bind(null,"square");const triangle=osc.bind(null,"triangle");function oscBank(base,freqs,types,gains,ac){var g,src;if(!isNum$1(base))base=1;if(!isArray(freqs))freqs=[1];if(!isArray(gains))gains=[1];if(!isArray(types))types=["sine"];var tl=types.length;var gl=gains.length;return connect(add(freqs.map(function(freq,i){src=osc(types[i%tl],base*freq);g=gains[i%gl];return g===1?src:connect(src,gain(g))})),gain(1/freqs.length))}function filter(type,frequency,Q,detune,ac){var filter=context(ac).createBiquadFilter();filter.type=type;return lifecycle(filter,[plug("frequency",frequency,filter),plug("Q",Q,filter),plug("detune",detune,filter)])}const lowpass=filter.bind(null,"lowpass");const hipass=filter.bind(null,"highpass");const bandpass=filter.bind(null,"hipass");function detune(cents,mod,ac){if(!isNum$1(cents))cents=50;if(isNum$1(mod))mod=sine(mod,ac);return mult(cents,mod)}function source(buffer,loop,detune,ac){var src=context(ac).createBufferSource();src.buffer=isFn(buffer)?buffer():buffer;if(!src.buffer)console.warn("Buffer not ready.");src.loop=loop;return lifecycle(src,[plug("detune",detune,src)])}function generate(generators,samples,reverse,ac){return function(){if(!Array.isArray(generators))generators=[generators];samples=samples||0;reverse=reverse===true;var numOfChannels=generators.length;var buffer=context(ac).createBuffer(numOfChannels,samples,samplingRate(ac));for(var ch=0;ch<numOfChannels;ch++){generateData(generators[ch],buffer.getChannelData(ch),samples,reverse)}return buffer}}function generateData(generator,data,samples,reverse){for(var i=0;i<samples;i++){data[i]=generator(reverse?samples-i:i)}}function white(samples,loop,ac){if(!isNum$1(samples))samples=samplingRate(ac);loop=loop!==false;return source(generate(whiteGen,samples,false,ac),loop,0,ac)}function whiteGen(){return Math.random()*2-1}function schedule(param,shape,times,types,ac){return function(when$$1,delay){console.log(shape,times,types);var type;var time=toTime(context,when$$1,delay);var lt=times.length;var tp=types.length;shape.forEach(function(value,i){time+=times[i%lt];type=types[i%tp];console.log(value,time,type);if(type==="set")param.setValueAtTime(value,time);else if(type==="exp")param.exponentialRampToValueAtTime(value===0?1e-5:value,time);else param.linearRampToValueAtTime(value,time)})}}function env(shape,times,types,ac){var ctx=context(ac);var gain$$1=ctx.createGain();gain$$1.gain.value=0;gain$$1.start=schedule(gain$$1.gain,shape,times,types,ctx);return gain$$1}function toNum(num,def){return isNum$1(num)?num:def}function adshr(attack,decay,sustain,hold,release,ac){attack=toNum(attack,.01);decay=toNum(decay,.1);sustain=toNum(sustain,1);hold=toNum(hold,0);release=toNum(release,.3);return env([0,1,sustain,sustain,0],[0,attack,decay,hold,release],["set","lin","set","exp"],ac)}function perc(attack,decay,ac){return adshr(attack,0,1,0,decay,ac)}function freqEnv(freq,octs,a,d,s,r,ac){return scale(freq,freq*Math.pow(2,octs),adshr(a,d,s,0,r,ac))}function mix(wet,fx){if(!isNum$1(wet))wet=.5;return add(gain(1-.5),connect(fx,gain(wet)))}function bus(fx){return function(wet){return mix(wet,fx)}}function feedback(amount,signal$$1,fx,ac){fx=fx||bypass(ac);var feed=gain(amount,ac);connect(fx,signal$$1,feed);feed.connect(fx);return signal$$1}function tremolo(rate,type,ac){type=type||"sine";return gain(osc(type,rate,ac),ac)}function dly(time,ac){var dly=context(ac).createDelay(5);return lifecycle(dly,[plug("delayTime",time,dly)])}function delay(time,filter$$1,feedAmount,ac){if(!isNum$1(feedAmount))feedAmount=.3;filter$$1=isNum$1(filter$$1)?lowpass(filter$$1,null,null,ac):filter$$1||bypass(ac);return feedback(feedAmount,dly(time,ac),filter$$1,ac)}var slice$1=Array.prototype.slice;function withOptions(fn,config){config=config||{};config.toOptions=config.toOptions||freqAndContextToOpts;return function(options){if(!isObj(options))options=config.toOptions.apply(null,arguments);return fn(Object.assign({},config.defaults,options))}}function freqAndContextToOpts(frequency,context$$1){return{frequency:frequency,context:context$$1}}var master=inst(null,dest());function inst(synth,destination,maxVoices){var i={};var voices=initVoices(maxVoices);i.start=function(value,time,delay,duration){var node=isFn(synth)?synth(value):value;if(destination)node.connect(destination);trackNode(voices,node);time=when(time,delay,contextOf(destination));node.start(time);if(duration)node.stop(time+duration);return node};i.track=trackNode.bind(null,voices);i.stop=function(){return stopAll(voices)};i.inst=function(synth,maxVoices){return inst(synth,destination,maxVoices)};i.on=on.bind(null,i);i.trigger=trigger.bind(null,i);return i}function initVoices(limit){limit=limit||0;return{limit:limit,all:{},nextId:0,current:0,pool:new Array(limit)}}function trackNode(voices,node){node.id=voices.nextId++;voices.all[node.id]=node;on(node,"ready",function(_,name){console.log("Instrument ready:",name)});return node}function stopAll(voices){Object.keys(voices.all).forEach(function(id){voices.all[id].stop()})}function on(target,event,callback){if(!event||event==="*")event="event";var prev=target["on"+event];target["on"+event]=function(){if(prev)prev.apply(null,arguments);callback.apply(null,arguments)}}function trigger(target,event){if(!isFn(target["on"+event]))return;var args=slice$1.call(arguments,2);target["on"+event].apply(null,args);if(isFn(target.onevent))target.onevent.apply(null,args)}exports.context=context;exports.now=now;exports.dest=dest;exports.samplingRate=samplingRate;exports.seconds=seconds;exports.tempo=tempo;exports.note=note;exports.hz=hz;exports.dB=dB;exports.gainToDb=gainToDb;exports.load=load;exports.decodeAudio=decodeAudio;exports.fetch=fetch;exports.connect=connect;exports.add=add;exports.constant=constant;exports.bypass=bypass;exports.gain=gain;exports.signal=signal;exports.mult=mult;exports.scale=scale;exports.osc=osc;exports.sine=sine;exports.saw=saw;exports.square=square;exports.triangle=triangle;exports.oscBank=oscBank;exports.filter=filter;exports.lowpass=lowpass;exports.hipass=hipass;exports.bandpass=bandpass;exports.detune=detune;exports.generate=generate;exports.source=source;exports.white=white;exports.adshr=adshr;exports.perc=perc;exports.freqEnv=freqEnv;exports.mix=mix;exports.bus=bus;exports.feedback=feedback;exports.tremolo=tremolo;exports.dly=dly;exports.delay=delay;exports.inst=inst;exports.master=master;exports.withOptions=withOptions;Object.defineProperty(exports,"__esModule",{value:true})});